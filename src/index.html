<!DOCTYPE html>
<html>
  <head>
    <title>Hearts</title>
    <style>
      #scrollit{
        overflow:scroll;
        height:300px;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      
      form input { border: 0; padding: 10px; width: 30%; margin-right: 0.5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <div style="border-style:solid;border-width: 30px;border-color: white;">

    <audio id="shuffle">
      <source src="https://cdn.glitch.com/b054eae9-1b6d-44bf-9acd-71938f6abce0%2Fshuffle.mp3" type="audio/mpeg">
    </audio>  
    
       
      <table style="table-layout:fixed;width:100%" border="0">
          <tr>
              <th style="width: 60%;"></th>
              <th style="width: 40%;"></th>
          </tr>
         <tr> 
          <td label="td1">
    
           <table style="table-layout:fixed;width:100%" border="0">
              <tr>
                <td colspan="2">
                    <div id="player2" style="text-align: center" >
                    </div>
                </td>
              </tr>
              <tr>
                <td>
                    <div id="player1">
                    </div>
                  </td>
                <td>
                    <div id="player3" style="text-align: right">
                    </div>
                  </td>
              </tr>
              <tr>
                <td colspan="2">
                    <div id="player0" style="text-align: center">
                    </div>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                    <div id="hand"></div>
                </td>
              </tr>
           </table>   
         </td>
          <td label="td2">     
           <div id="scrollit"> 
             <ul id="messages"></ul>
           </div> 
           <button type="button" style="height:40px;width:100px" onclick="startOver()">Start Over</button>
           <button type="button" style="height:40px;width:100px" onclick="doDeal()">Deal</button>
           <button type="button" style="height:40px;width:100px" onclick="doTake()">Take Trick</button>
           <button type="button" style="height:40px;width:100px" onclick="doUntake()">Untake Trick</button>
           <form> 
             <input id="m" autocomplete="off" /><button>Send</button>
           </form>
          </td>
        </tr>
      </table>    
 
    <!-- script src="/socket.io/socket.io.js" -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" ></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
      //CARDS_URL = "https://cdn.glitch.com/b054eae9-1b6d-44bf-9acd-71938f6abce0%2F"
      CARDS_URL = "/assets/cards/"
        
      $(function() {
        console.log("jQuery ...");
        socket = io();

        name = getQueryVariable("name");
        //console.log(name);
        document.title = name;
        var data = { method: "name", name: name };
        var msg = JSON.stringify(data);
        socket.emit("chat message", msg);

        $("form").submit(function(e) {
          e.preventDefault(); // prevents page reloading
          var msg = $("#m").val();
          if (msg === "deal") {
            msg = '{"method" : "deal"}';
          }
          if (msg === "take") {
            msg = '{"method" : "take"}';
          }
          if (msg.startsWith("play")) {
            var s = msg.split(" ");
            msg = '{"method" : "play", "card" : "' + s[1] + '"}';
          }
          socket.emit("chat message", msg);
          console.log("chat message: " + msg) 
          $("#m").val("");
          return false;
        });
      
        socket.on("chat message", function(msg) {
          //alert(msg); 
          $("#messages").append($("<li>").text(msg));
          document.getElementById("messages").scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
          if (msg.includes("broken")) {
              var hearts_broken = new Audio('https://cdn.glitch.com/b054eae9-1b6d-44bf-9acd-71938f6abce0%2FTrain_Honk_Horn_Clear-Mike_Koenig-1632487478.mp3?v=1591385849402.mp3');
              hearts_broken.play();
          } 
        });
        
        socket.on("shoot the moon", function() {   /// this communicates that the moon has been shot
          console.log('shoot the moon');   
          
          //value is true if go to zero or false if double everyone's score.
          var value = confirm("Congratulations! You shot the moon. Press OK to go to zero, or Cancel to double everyone else's score.");
          
          msg = '{"method" : "shootTheMoon", "option" : "' + ( value ? 'zero' : 'double' ) + '"}';
          
          socket.emit("chat message", msg);
          
        });
          
        socket.on("update", async function(data) {
         console.log(data);  
          
         if(data.shuffle){ 
           document.getElementById("shuffle").play();
           await sleep(6000); 
           console.log('hello world...'); 
         }
          
         //draw play positions: 
         for(var pos = 0; pos < 4; pos++){ 
          
           var player = ( pos + data.player ) % 4; 
           var position = document.getElementById("player" + pos); 
           position.innerHTML = "";  
          
          //add name:
           var name = document.createElement("div");  
           name.innerHTML = data.players[player].name ;
           if(player == data.leader) {
             name.style.color = "red";
           }  
           position.appendChild(name);  
           position.appendChild(document.createElement("br")); 

          //add played cards:
           if(data.passed[player].length > 0){ 
             var passed = data.passed[player]; 
             for(var i = 0; i < passed.length; i++){ 
               var cardId = passed[i];
               var card = document.createElement("img"); 
               card.setAttribute("src", CARDS_URL + cardId + ".png"); 
               card.setAttribute("width", "60")   // adjust card size 
               if(cardId != 'back') { 
                 card.setAttribute("onclick", "accept();");    
               } 
               position.appendChild(card); 
             }
           }
           else { 
             var played = data.plays[player]; 
             var cardId = (played.length === 1) ? played[0] : 'blank';
             var card = document.createElement("img"); 
             card.setAttribute("src", CARDS_URL + cardId + ".png"); 
             if((cardId != 'blank') && (pos == 0)){ 
               card.setAttribute("onclick", "unplay();");    
             }
             card.setAttribute("width", "60")
             position.appendChild(card);  
           }

          }
         //draw the hand:
          var hand = document.getElementById("hand");
          hand.innerHTML = "" ;  
          for(var i = 0; i < data.hand.length; i++){ 
            var cardId = data.hand[i];
            var card = document.createElement("img"); 
           //<img src="/cards/JC.png" width="50">
            card.setAttribute("src", CARDS_URL + cardId + ".png"); 
            card.setAttribute("width", "60")
            card.setAttribute("onclick", "pick('" + cardId + "');");    
            hand.appendChild( card );    
          } 
        });
        /*
        socket.on("getname", function(data) {
          socket.emit("chat message", '{"method":"name","name":"' + name + '"}');
        }); 
        */
      });

      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split("=");
          if (pair[0] == variable) {
            return pair[1];
          }
        }
      }

      function pick(card){ 
        console.log("picking " + card); 
        socket.emit("chat message", '{"method":"play","card":"' + card + '"}');  
      } 

      function unplay(){ 
        socket.emit("chat message", '{"method":"unplay"}');  
      }

      function accept(){ 
        socket.emit("chat message", '{"method":"accept"}');  
      }
      
      function doUntake(){ 
        socket.emit("chat message", '{"method" : "untake"}');
      }

      function doTake(){ 
        socket.emit("chat message", '{"method" : "take"}');
      }

      /**
      async function playShuffle(){ 
      }
      **/
      
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      
      function doDeal(){ 
        socket.emit("chat message", '{"method" : "deal"}');
      }

      function startOver(){ 
        console.log("name = " + name); 
        if(name == "andrew"){ 
          socket.emit("chat message", '{"method" : "startOver"}');
        }
        else
        {
          alert("Ooops! You are NOT a super-user!")
        }
      }

      setInterval(client_keepalive, 500);

      function client_keepalive(){
        socket.emit("chat message", '{"method" : "client_keepalive" }');
      }
      
    </script>
    </div>  
  </body>
</html>
